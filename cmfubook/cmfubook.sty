%       cmfubook.sty    coded by YIN Dian
%       Provide \cmfuinput to include a raw .txt file for novels downloaded
%       from cmfu.com. 
%       Hist:   071215  First coded. Title extracted and end-of-file-ads
%                       removed. Completed section handling. Fixed toc bug
%                       caused by \XeTeXdefaultencoding. Advertisements
%                       removed. Works well under XeLaTeX.
\NeedsTeXFormat{LaTeX2e}[1996/12/01]
\def\filedate{2007/12/18}
\ProvidesPackage{cmfubook}[\filedate]
\RequirePackage{zhspacing}
\zhspacing
\RequirePackage{zhfont}
\XeTeXinputencoding "cp936"
\endlinechar=-1
%\DeclareOption{}{}
%\ProcessOptions\relax

\newif\ifcmfu@result
\def\cmfu@lastline{}
\def\cmfu@currline{}
\newcommand\cmfuupdate[1]{\begingroup\small #1\endgroup\par\medskip}

\def\cmfu@amp#1;{
  \&#1;
}
{\catcode`\<=\active
\gdef\cmfu@langle#1>#2</#3>{
  #2
}}
\def\cmfu@lbrack#1/#2]{\cmfu@settitle{#1}\@makeother\[\cmfu@seteverypar}
\def\cmfu@testcopyright#1Copyright#2\@nil{
  \if!#2!
    \cmfu@resultfalse
  \else
    \cmfu@resulttrue
  \fi
}
\def\cmfu@testrightgrant#1本书已获作者授权在起点#2\@nil{
  \if!#2!
    \cmfu@resultfalse
  \else
    \cmfu@resulttrue
  \fi
}
\def\cmfu@testupdatetime#1网更新时间：#2\@nil{
  \if!#2!
    \cmfu@resultfalse
  \else
    \cmfu@resulttrue
  \fi
}
\def\cmfu@testqdzwwsqfb#1起#2点#3中#4文#5网#6授权发#7\@nil{
  \if!#7!
    \cmfu@resultfalse
  \else
    \cmfu@resulttrue
  \fi
}
\def\cmfu@testqdzww#1起#2点#3中#4文#5#6#7网#8\@nil{
  \if!#6!
    \cmfu@resultfalse
  \else
    \if!#7!
      \cmfu@resulttrue
    \else
      \cmfu@resultfalse
    \fi
  \fi
}
\def\cmfu@testhsjzcmfu#1好书尽在www.cmfu.#2\@nil{
  \if!#2!
    \cmfu@resultfalse
  \else
    \cmfu@resulttrue
  \fi
}
\def\cmfu@stripqdzwwsqfb#1起#2点#3中#4文#5网#6授权发布#7\@nil{#1#7}
\def\cmfu@stripqdzww#1起#2点#3中#4文#5#6#7网#8\@nil{#1#8}
\def\cmfu@striphsjzcmfu#1好书尽在www.cmfu.com#2\@nil{#1#2}
\def\cmfu@stripads#1{
  \edef\cmfu@tmp{#1}
  \expandafter\cmfu@testqdzwwsqfb\cmfu@tmp 起8K点8K中8K文8K网8K授权发\@nil
  \ifcmfu@result
    \edef\cmfu@tmp{\expandafter\cmfu@stripqdzwwsqfb\cmfu@tmp\@nil}
  \fi
  \expandafter\cmfu@testqdzww\cmfu@tmp 起8K点8K中8K文aaaa网\@nil
  \ifcmfu@result
    \edef\cmfu@tmp{\expandafter\cmfu@stripqdzww\cmfu@tmp\@nil}
  \fi
  \expandafter\cmfu@testhsjzcmfu\cmfu@tmp 好书尽在www.cmfu.\@nil
  \ifcmfu@result
    \edef\cmfu@tmp{\expandafter\cmfu@striphsjzcmfu\cmfu@tmp\@nil}
  \fi
  \edef#1{\cmfu@tmp}
}
{\catcode`\^^M=12
\gdef\cmfu@newline#1^^M{
  %#1\par
  \if!#1!% empty
    \ifhmode
      \vskip -\baselineskip
      \vskip -\parskip
    \fi
  \else
    \ifx\cmfu@lastline\empty
        \def\cmfu@lastline{#1}
      %\leavevmode\par
      \ifhmode
        \vskip -\baselineskip
        \vskip -\parskip
      \fi
      %\message{empty}
    \else
      \def\cmfu@currline{#1}
      \expandafter\cmfu@testcopyright\cmfu@lastline Copyright\@nil
      \ifcmfu@result % last line contains Copyright
        \immediate\write16{Copyright encountered}
        \expandafter\cmfu@testrightgrant\cmfu@currline 本书已获作者授权在起点\@nil
        \ifcmfu@result % current line contains 本书已获作者授权在起点
          \catcode`\^^M=5
          \immediate\write16{The cmfu file ended}
          \endinput
        \else
          \cmfu@processline
        \fi
      \else
        \cmfu@processline
      \fi
    \fi
  \fi
}}

\def\cmfu@processline{
  %\cmfu@lastline\par
  \expandafter\cmfu@testupdatetime\cmfu@currline 网更新时间：\@nil
  \ifcmfu@result % new section
    \begingroup
      \everypar{}
      \expandafter\section\expandafter{\cmfu@lastline}
      \cmfu@stripads\cmfu@currline
      \expandafter\cmfuupdate\expandafter{\cmfu@currline}\par
    \endgroup
    \def\cmfu@currline{}
  \else
    \cmfu@lastline\par
  \fi
  %\immediate\write16{Last line: \cmfu@lastline}
  \cmfu@stripads\cmfu@currline
  \edef\cmfu@lastline{\cmfu@currline}
}

\def\cmfu@seteverypar{
  \everypar{\cmfu@newline}
}

\def\cmfu@setcatcode{\let\do\@makeother\dospecials
  \count@=\lccode`\~
  \catcode`\&=\active \lccode`\~=`\&
  \lowercase{\let~=\cmfu@amp}
  \catcode`\<=\active \lccode`\~=`\<
  \lowercase{\let~=\cmfu@langle}
  %\catcode`\^^M=\active \lccode`\~=`\^^M
  %\lowercase{\let~=\cmfu@newline}
  \@makeother\^^M
  \catcode`\　=10% make fullwidth space space
  \catcode`\[=\active \lccode`\~=`\[
  \lowercase{\let~=\cmfu@lbrack}
}

\newcommand{\cmfuinput}[1]{
  \begingroup
  \XeTeXdefaultencoding "cp936"
  \endlinechar=`\^^M
  \cmfu@setcatcode
  \immediate\write16{Start parsing file...}
  \input #1
  \XeTeXdefaultencoding "utf-8"
  \endgroup
}

\def\cmfu@settitle#1{\title{#1}
  \maketitle
  \XeTeXdefaultencoding "utf-8"
  \endgroup\maketitle\vfil
  \tableofcontents\vfil\newpage\begingroup
  \XeTeXdefaultencoding "cp936"
  \endlinechar=`\^^M
  \cmfu@setcatcode
  \immediate\write16{Done generating title and toc}
}

\endinput
